
name: PyJobKit Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:

permissions:
  contents: read

jobs:
  test:
    if: endsWith(github.repository, '/pyjobkit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          allow-prereleases: true
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install pytest pytest-cov
      - name: Run tests with coverage
        run: pytest --cov=pyjobkit --cov-report=xml --cov-report=term
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Update coverage badge gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: 99574c3e4a5b6f3890c375bde7e1f0cd
        run: |
          pip install xmltodict
          COVERAGE=$(python -c "import xmltodict; d=xmltodict.parse(open('coverage.xml').read()); print(d['coverage']['@line-rate'])")
          PERCENT=$(python -c "print(int(round(float('$COVERAGE')*100)))")
          echo '{"schemaVersion":1,"label":"coverage","message":"'${PERCENT}'%","color":"green"}' > coverage-summary.json
          curl -X PATCH -H "Authorization: token $GIST_TOKEN" \
            -d @<(echo '{"files": {"coverage-summary.json": {"content": '$(cat coverage-summary.json)'}}}') \
            https://api.github.com/gists/$GIST_ID
